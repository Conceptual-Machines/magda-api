---
# Proper Ansible role for infrastructure management
# This actually uses Ansible modules instead of raw AWS CLI

- name: "ðŸ”§ AIDEAS API Infrastructure Management"
  hosts: localhost
  gather_facts: false
  vars:
    instance_name: "aideas-api-production"
    security_group_name: "aideas-api-sg"
    eip_tag_name: "aideas-api-production-eip"
    vpc_id: "vpc-f9b02891"
    rds_security_group_id: "sg-067490199295a88a9" # aideas-music-db RDS security group

  tasks:
    - name: "ðŸ” Check current infrastructure status"
      debug:
        msg: "Checking infrastructure status..."

    - name: "ðŸ” Check if security group exists"
      ec2_group_info:
        filters:
          "group-name": "{{ security_group_name }}"
      register: existing_sg

    - name: "ðŸ”’ Create security group if it doesn't exist"
      ec2_group:
        name: "{{ security_group_name }}"
        description: "Security group for AIDEAS API"
        vpc_id: "{{ vpc_id }}"
        rules:
          - proto: tcp
            ports:
              - 22
            cidr_ip: 0.0.0.0/0
            rule_desc: "SSH access"
          - proto: tcp
            ports:
              - 80
            cidr_ip: 0.0.0.0/0
            rule_desc: "HTTP"
          - proto: tcp
            ports:
              - 443
            cidr_ip: 0.0.0.0/0
            rule_desc: "HTTPS"
          - proto: all
            cidr_ip: 0.0.0.0/0
            rule_desc: "All outbound traffic"
            rule_type: egress
        state: present
      when: existing_sg.security_groups | length == 0

    - name: "ðŸ” Check if EIP exists"
      ec2_eip_info:
        filters:
          "tag:Name": "{{ eip_tag_name }}"
      register: existing_eip

    - name: "ðŸŒ Create EIP if it doesn't exist"
      ec2_eip:
        domain: vpc
        state: present
        tags:
          Name: "{{ eip_tag_name }}"
      register: new_eip
      when: existing_eip.addresses | length == 0

    - name: "ðŸ” Check if EC2 instance exists"
      ec2_instance_info:
        filters:
          "tag:Name": "{{ instance_name }}"
          "instance-state-name": "running"
      register: existing_instance

    - name: "ðŸ“Š Display infrastructure status"
      debug:
        msg: |
          Security Group: {{ existing_sg.security_groups[0].group_id if existing_sg.security_groups else 'Will be created' }}
          EIP: {{ existing_eip.addresses[0].allocation_id if existing_eip.addresses else 'Will be created' }}
          EC2 Instance: {{ existing_instance.instances[0].instance_id if existing_instance.instances else 'Not found' }}

    - name: "ðŸ” Allow EC2 to access RDS database"
      ec2_group:
        group_id: "{{ rds_security_group_id }}"
        rules:
          - proto: tcp
            ports:
              - 5432
            group_id: "{{ existing_sg.security_groups[0].group_id }}"
            rule_desc: "Allow API server to connect to database"
        state: present
      when: existing_sg.security_groups | length > 0

    - name: "âš ï¸ Warning about existing resources"
      debug:
        msg: "Resources already exist - no changes needed"
      when: existing_sg.security_groups | length > 0 and existing_eip.addresses | length > 0
