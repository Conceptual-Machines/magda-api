---
# Setup Cloudflare Origin Certificates for AIDEAS API
# Certificates are stored in AWS Secrets Manager and deployed to the server

- name: "ğŸ” Setup Cloudflare Origin SSL Certificates"
  hosts: production
  gather_facts: true
  vars:
    app_dir: "/opt/aideas-api"
    secret_name: "aideas-api-ssl-cert"
    aws_region: "eu-west-2"

  tasks:
    - name: "ğŸ” Check if SSL secret exists in AWS Secrets Manager"
      shell: |
        aws secretsmanager describe-secret \
          --secret-id {{ secret_name }} \
          --region {{ aws_region }} 2>&1
      register: secret_check
      ignore_errors: true
      delegate_to: localhost
      become: false

    - name: "âš ï¸ SSL certificates not found in Secrets Manager"
      fail:
        msg: |
          SSL certificates not found in AWS Secrets Manager!

          Please create Cloudflare Origin Certificate and store it:

          1. Go to Cloudflare Dashboard â†’ SSL/TLS â†’ Origin Server
          2. Click "Create Certificate"
          3. Select:
             - Private key type: RSA (2048)
             - Hostnames: api.musicalaideas.com, *.musicalaideas.com
             - Certificate Validity: 15 years
          4. Copy the certificate and private key
          5. Store in AWS Secrets Manager:

             aws secretsmanager create-secret \
               --name {{ secret_name }} \
               --description "Cloudflare Origin Certificate for AIDEAS API" \
               --secret-string '{
                 "certificate": "-----BEGIN CERTIFICATE-----\n...\n-----END CERTIFICATE-----",
                 "private_key": "-----BEGIN PRIVATE KEY-----\n...\n-----END PRIVATE KEY-----"
               }' \
               --region {{ aws_region }}

          Then run this playbook again.
      when: secret_check.rc != 0

    - name: "ğŸ“¥ Retrieve SSL certificates from AWS Secrets Manager"
      shell: |
        aws secretsmanager get-secret-value \
          --secret-id {{ secret_name }} \
          --region {{ aws_region }} \
          --query SecretString \
          --output text
      register: ssl_secret
      delegate_to: localhost
      become: false

    - name: "ğŸ“ Create SSL directory"
      file:
        path: "{{ app_dir }}/ssl"
        state: directory
        owner: ubuntu
        group: ubuntu
        mode: "0755"
      become: true

    - name: "ğŸ“ Write certificate file"
      copy:
        content: "{{ (ssl_secret.stdout | from_json).certificate }}"
        dest: "{{ app_dir }}/ssl/certificate.pem"
        owner: ubuntu
        group: ubuntu
        mode: "0644"
      become: true

    - name: "ğŸ” Write private key file"
      copy:
        content: "{{ (ssl_secret.stdout | from_json).private_key }}"
        dest: "{{ app_dir }}/ssl/private.key"
        owner: ubuntu
        group: ubuntu
        mode: "0600"
      become: true

    - name: "ğŸ”„ Restart nginx to apply certificates"
      shell: docker restart aideas-api-nginx-prod
      become: true

    - name: "âœ… Verify nginx is running"
      shell: docker ps | grep aideas-api-nginx-prod
      register: nginx_status
      become: true

    - name: "ğŸ“‹ Display nginx status"
      debug:
        var: nginx_status.stdout_lines

    - name: "âœ… SSL setup complete"
      debug:
        msg: |
          âœ… Cloudflare Origin Certificates deployed successfully!

          Certificate location: {{ app_dir }}/ssl/
          Nginx status: {{ nginx_status.stdout }}

          Note: Certificates are valid for 15 years and don't need renewal.
