---
# Deploy application to existing EC2 instance
# This replaces the buggy GitHub Actions deployment

- name: "ğŸ“¦ Deploy AIDEAS API to existing instance"
  hosts: production
  gather_facts: true
  vars:
    app_dir: "/opt/aideas-api"
    docker_image: "{{ image_tag | default('086060940749.dkr.ecr.eu-west-2.amazonaws.com/aideas-api:latest') }}"
    workspace_root: "{{ lookup('env', 'GITHUB_WORKSPACE') | default(playbook_dir + '/../../..', true) }}"

  tasks:
    - name: "ğŸ“ Create application directory"
      file:
        path: "{{ app_dir }}"
        state: directory
        owner: ubuntu
        group: ubuntu
        mode: "0755"
      become: true

    - name: "ğŸ” Login to ECR"
      shell: |
        aws ecr get-login-password --region eu-west-2 | docker login --username AWS --password-stdin 086060940749.dkr.ecr.eu-west-2.amazonaws.com
      become: true

    - name: "ğŸ“¥ Pull latest Docker image"
      community.docker.docker_image:
        name: "{{ docker_image }}"
        source: pull
        force_source: true
      become: true

    - name: "ğŸ“‹ Copy docker-compose.prod.yml"
      copy:
        src: "{{ workspace_root }}/docker-compose.prod.yml"
        dest: "{{ app_dir }}/docker-compose.prod.yml"
        mode: "0644"

    - name: "ğŸ“‹ Copy nginx.conf"
      copy:
        src: "{{ workspace_root }}/nginx.conf"
        dest: "{{ app_dir }}/nginx.conf"
        mode: "0644"

    - name: "ğŸ” Create .env file with secrets"
      copy:
        content: |
          ENVIRONMENT=production
          DATABASE_URL={{ lookup('env', 'DATABASE_URL') }}
          JWT_SECRET={{ lookup('env', 'JWT_SECRET') }}
          OPENAI_API_KEY={{ lookup('env', 'OPENAI_API_KEY') }}
          GEMINI_API_KEY={{ lookup('env', 'GEMINI_API_KEY') }}
          MCP_SERVER_URL={{ lookup('env', 'MCP_SERVER_URL') }}
          SENTRY_DSN={{ lookup('env', 'SENTRY_DSN') }}
          FRONTEND_URL={{ lookup('env', 'FRONTEND_URL') | default('https://beta.musicalaideas.com') }}
          AWS_REGION={{ lookup('env', 'AWS_REGION') | default('eu-west-2') }}
        dest: "{{ app_dir }}/.env"
        mode: "0644"
        owner: ubuntu
        group: ubuntu
      become: true

    - name: "ğŸ” Setup SSL certificates from AWS Secrets Manager"
      block:
        - name: "ğŸ“¥ Retrieve SSL certificates from AWS Secrets Manager"
          shell: |
            aws secretsmanager get-secret-value \
              --secret-id aideas-api-ssl-cert \
              --region eu-west-2 \
              --query SecretString \
              --output text
          register: ssl_secret
          delegate_to: localhost
          become: false

        - name: "ğŸ“ Create SSL directory"
          file:
            path: "{{ app_dir }}/ssl"
            state: directory
            owner: ubuntu
            group: ubuntu
            mode: "0755"
          become: true

        - name: "ğŸ“ Write certificate file"
          copy:
            content: "{{ (ssl_secret.stdout | from_json).certificate }}"
            dest: "{{ app_dir }}/ssl/certificate.pem"
            owner: ubuntu
            group: ubuntu
            mode: "0644"
          become: true

        - name: "ğŸ” Write private key file"
          copy:
            content: "{{ (ssl_secret.stdout | from_json).private_key }}"
            dest: "{{ app_dir }}/ssl/private.key"
            owner: ubuntu
            group: ubuntu
            mode: "0600"
          become: true
      rescue:
        - name: "âš ï¸ SSL certificate setup failed - continuing without SSL"
          debug:
            msg: "SSL certificates could not be deployed. Nginx will run without SSL."

    - name: "ğŸ”„ Restart application"
      community.docker.docker_compose_v2:
        project_src: "{{ app_dir }}"
        files:
          - docker-compose.prod.yml
        state: present
        recreate: always
      become: true
      environment:
        API_IMAGE: "{{ docker_image }}"

    - name: "ğŸ” Check container status"
      shell: docker ps -a
      register: docker_ps
      become: true

    - name: "ğŸ“‹ Show container status"
      debug:
        var: docker_ps.stdout_lines

    - name: "ğŸ“‹ Show container logs"
      shell: docker logs aideas-api-prod --tail 50
      register: container_logs
      become: true
      ignore_errors: true

    - name: "ğŸ“‹ Display container logs"
      debug:
        var: container_logs.stdout_lines

    - name: "âœ… Verify application is running"
      uri:
        url: "https://api.musicalaideas.com/health"
        method: GET
        status_code: 200
        validate_certs: yes
      retries: 5
      delay: 10
      delegate_to: localhost
